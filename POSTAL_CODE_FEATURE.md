# 郵便番号住所自動補完機能

日本郵便の郵便番号データを活用した住所自動補完機能を実装しました。

## 実装概要

### 追加されたファイル

1. **`app/api/postal-code/route.ts`**
   - 郵便番号検索API エンドポイント
   - CORS対応版の日本郵便API（digital-address.app）を使用
   - 郵便番号の正規化と形式チェック機能

2. **`components/ui/postal-code-input.tsx`**
   - 郵便番号入力と住所自動補完のUIコンポーネント
   - リアルタイム郵便番号フォーマット機能（ハイフン自動挿入）
   - 検索ステータス表示（検索中、成功、エラー）
   - キーボードナビゲーション対応（Enterキーでの検索実行）

### 修正されたファイル

1. **`app/crowdfunding/[id]/edit/_components/sections/project-owner-form.tsx`**
   - 法人情報の住所入力欄を郵便番号検索対応に変更
   - 特商法表記の事業者住所入力欄を郵便番号検索対応に変更
   - 既存のTextareaを新しいPostalCodeInputコンポーネントに置き換え

## 機能の特徴

### 📮 郵便番号自動フォーマット
- 入力時に自動でハイフンを挿入（例: 1500002 → 150-0002）
- 数字のみ入力可能、最大8文字制限

### 🔍 住所検索機能
- 郵便番号入力後、検索ボタンクリックまたはEnterキーで住所検索
- 検索結果を住所フィールドに自動入力
- 検索中はローディング表示

### ✅ ステータス表示
- 検索成功時: 緑色のチェックマークとメッセージ
- エラー時: 赤色の警告アイコンとエラーメッセージ
- 入力値の境界線色もステータスに応じて変更

### 🎯 ユーザビリティ
- レスポンシブデザイン対応
- アクセシビリティ配慮（ラベル、ARIA属性）
- 建物名・部屋番号の追記説明文

## API仕様

### エンドポイント
```
GET /api/postal-code?zip={郵便番号}
```

### パラメータ
- `zip`: 郵便番号（7桁、ハイフンあり・なし両対応）

### レスポンス形式

#### 成功時
```json
{
  "success": true,
  "address": {
    "zip_code": "150-0002",
    "prefecture": "東京都",
    "city": "渋谷区",
    "town": "渋谷",
    "formatted_address": "東京都渋谷区渋谷",
    "full_address": "東京都渋谷区渋谷"
  },
  "source": "digital-address.app"
}
```

#### エラー時
```json
{
  "error": "該当する住所が見つかりません",
  "address": null
}
```

## 使用方法

### 基本的な使い方

1. 郵便番号欄に7桁の郵便番号を入力
2. 検索ボタンをクリック、またはEnterキーを押下
3. 住所が自動的に住所欄に入力される
4. 必要に応じて建物名・部屋番号を追記

### エラーハンドリング

- **無効な郵便番号**: 「郵便番号は7桁で入力してください」
- **該当なし**: 「該当する住所が見つかりません」
- **API エラー**: 「住所検索中にエラーが発生しました」

## テスト方法

### 1. 開発サーバーの起動
```bash
npm run dev
```

### 2. ページアクセス
クラウドファンディングプロジェクトの編集ページにアクセス:
```
http://localhost:3000/crowdfunding/[project_id]/edit
```

### 3. テスト用郵便番号

以下の郵便番号でテストできます:

- **100-0001** (東京都千代田区千代田)
- **150-0002** (東京都渋谷区渋谷)
- **000-0000** (存在しない郵便番号 - エラーテスト用)

### 4. 動作確認項目

#### ✅ 基本動作
- [ ] 郵便番号入力時のハイフン自動挿入
- [ ] 検索ボタンクリックで住所検索
- [ ] Enterキーでの検索実行
- [ ] 検索結果の住所自動入力

#### ✅ エラーハンドリング
- [ ] 7桁未満の郵便番号でのエラー表示
- [ ] 存在しない郵便番号でのエラー表示
- [ ] 検索中のローディング表示

#### ✅ UI/UX
- [ ] レスポンシブデザインの動作
- [ ] 成功時の緑色表示
- [ ] エラー時の赤色表示
- [ ] 説明文の表示

## 運用における注意事項

### API選択の経緯（妥協点について）

**理想**: 日本郵便公式「郵便番号・デジタルアドレスAPI」の直接利用  
**現実**: 技術的制約により断念し、digital-address.appを選択

#### 日本郵便公式APIの制約
```markdown
❌ 固定IP必須
  - 送信元IPアドレスの事前登録が必要
  - 動的IPでは利用不可

❌ IPレンジ制限
  - 0.0.0.0/0（全IPからのアクセス）は不可
  - 広範囲のIPレンジ設定不可

❌ 登録IP数制限
  - 最大10個までの固定IPのみ登録可能
  - スケールアウト時の制約

❌ IPv6非対応
  - IPv4のみ対応
  - モダンなインフラとの親和性に課題
```

#### 現在の開発・運用環境での問題
```bash
# 使用中/検討中のサービスでの制約
❌ Vercel: 動的IP、固定IP取得困難
❌ Netlify: 同様に固定IP設定不可  
❌ Next.js App Router: Vercel最適化のため制約継承
⚠️ AWS/GCP: 固定IP取得可能だが追加コスト・運用負荷

# 実質的な選択肢
✅ GCP e2-micro + 静的IP（無料枠制限内）
✅ 自前サーバー + 固定IP契約（コスト・運用負荷大）
```

#### 妥協の判断理由
1. **開発効率**: 既存のVercel/Netlifyベースの開発フローを維持したい
2. **運用コスト**: 固定IP取得・管理による追加コスト回避
3. **技術負債**: インフラ変更による他機能への影響を最小化
4. **迅速な実装**: プロトタイプから本番まで一貫した環境での開発

**結論**: 技術的制約を回避し、開発効率と運用コストのバランスを取るため、digital-address.app を選択

### API利用について
- digital-address.app（CORS対応版日本郵便API）を使用
- 無料で商用利用可能
- 日本郵便の最新データに基づく高精度な住所情報

### データの精度
- 基本的な住所（都道府県・市区町村・町域）を取得
- 建物名・部屋番号は手動入力が必要
- 最新の郵便番号データに対応

### パフォーマンス
- APIレスポンスは1時間キャッシュ
- 安定したレスポンス時間
- 高い可用性を維持

### 安定性の監視
- 定期的なAPI応答確認を推奨
- エラー率の監視
- 障害時の早期検知体制

## 今後の改善点

1. **安定性・信頼性の向上**
   - API監視機能の実装
   - フォールバック機能の追加
   - エラー通知システムの構築

2. **機能拡張**
   - 住所からの郵便番号逆引き検索
   - 住所の曖昧検索機能
   - 複数候補がある場合の選択UI

3. **パフォーマンス最適化**
   - レスポンス時間の最適化
   - キャッシュ戦略の改善
   - 並行リクエスト処理の向上

4. **ユーザビリティ強化**
   - 住所候補のサジェスト機能
   - 入力履歴機能
   - 海外住所対応

5. **監視・運用機能**
   - リアルタイム監視ダッシュボード
   - パフォーマンスメトリクス収集
   - 自動アラート機能

## 実装推奨: API監視・フォールバック機能

### 監視機能の追加
```typescript
// API健全性チェック
export const healthCheck = async () => {
  try {
    const response = await fetch('/api/postal-code?zip=1000001')
    return response.ok
  } catch {
    return false
  }
}
```

### フォールバック戦略
```typescript
// 段階的フォールバック
const fallbackStrategies = [
  'digital-address.app',      // メイン
  'ローカル郵便番号DB',        // フォールバック1
  'ユーザー手動入力のみ'      // フォールバック2
]
```

## 参考資料

- [CORS対応版API (digital-address.app)](https://digital-address.app/)
- [デジタルアドレスについて](https://lp.da.pf.japanpost.jp/)
- [日本郵便 郵便番号検索](https://www.post.japanpost.jp/zipcode/) 
- [CORS対応版 郵便番号・デジタルアドレスAPIを開発しました digital-address.app ゆうID不要](https://qiita.com/relu/items/9b8085e89c01bcf6d35a)